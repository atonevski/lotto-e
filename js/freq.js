// Generated by CoffeeScript 1.10.0
var https, utils, vue;

utils = require('../js/utils.js');

https = require('https');

vue = new Vue({
  el: '#app',
  data: {
    count: null,
    lastDraw: {},
    lfreq: [],
    jfreq: [],
    drum: 'BOTH',
    showGraphs: true,
    LWIDTH: 800,
    LHEIGHT: 500,
    lmargins: {
      top: 20,
      right: 120,
      bottom: 20,
      left: 40
    }
  },
  filters: {
    number: function(v) {
      if ((v != null) && typeof v.toLocaleString === 'function') {
        return v.toLocaleString();
      } else {
        return '';
      }
    },
    toYMD: utils.toYMD,
    toDMY: utils.toDMY
  },
  methods: {
    toggleShow: function() {
      return this.showGraphs = !this.showGraphs;
    },
    getLastDraw: function() {
      var q;
      q = 'SELECT A, B\nORDER BY B DESC\nLIMIT 1\nLABEL A \'number\', B \'date\'';
      return https.get(utils.qstring(q), (function(_this) {
        return function(res) {
          var body;
          body = '';
          res.setEncoding('utf-8');
          res.on('data', function(d) {
            return body += d;
          });
          res.on('error', function(e) {
            return console.log("query error: " + e);
          });
          return res.on('end', function() {
            var json;
            json = utils.parseResponse(body.toString());
            return _this.lastDraw = (utils.qresult(json))[0];
          });
        };
      })(this));
    },
    getTotalDraws: function() {
      var q;
      q = 'SELECT COUNT(A)\nLABEL COUNT(A) \'count\'';
      return https.get(utils.qstring(q), (function(_this) {
        return function(res) {
          var body;
          body = '';
          res.setEncoding('utf-8');
          res.on('data', function(d) {
            return body += d;
          });
          res.on('error', function(e) {
            return console.log("query error: " + e);
          });
          return res.on('end', function() {
            var json;
            json = utils.parseResponse(body);
            return _this.count = (utils.qresult(json))[0].count;
          });
        };
      })(this));
    },
    drawLgraph: function() {
      var j, ref, results, svg, xAxis, xRange, xmax, xmin, yAxis, yRange, ymax, ymin;
      svg = d3.select('#id-lgraph').attr('class', 'axis').attr('width', this.LWIDTH + 'px').attr('height', this.LHEIGHT + 'px');
      ref = [1, 34], xmin = ref[0], xmax = ref[1];
      ymin = 0;
      ymax = d3.max(this.lfreq.slice(1, 35), function(n) {
        return n.reduce(function(x, s) {
          return x + s;
        }, 0);
      });
      xRange = d3.scaleBand().range([this.lmargins.left, this.LWIDTH - this.lmargins.right]).domain((function() {
        results = [];
        for (var j = xmin; xmin <= xmax ? j <= xmax : j >= xmax; xmin <= xmax ? j++ : j--){ results.push(j); }
        return results;
      }).apply(this)).padding(0.2);
      yRange = d3.scaleLinear().range([this.LHEIGHT - this.lmargins.top, this.lmargins.bottom]).domain([ymin, ymax]);
      xAxis = d3.axisBottom(xRange);
      yAxis = d3.axisLeft(yRange);
      console.log(svg);
      svg.append('g').attr('class', 'x axis').attr('transform', "translate(0, " + (this.LHEIGHT - this.lmargins.bottom) + ")").call(xAxis);
      return svg.append('g').attr('class', 'y axis').attr('transform', "translate(" + this.lmargins.left + ", 0)").call(yAxis);
    },
    getFreq: function() {
      var i, j, jq, lfreq, lq;
      lfreq = [];
      for (i = j = 0; j <= 34; i = ++j) {
        lfreq.push([0, 0, 0, 0, 0, 0, 0, 0]);
      }
      lq = 'SELECT X, Y, Z, AA, AB, AC, AD, AE\n:filter';
      lq = (function() {
        switch (this.drum) {
          case utils.VENUS:
            return lq.replace(/\:filter/, "WHERE B <= date '" + (utils.toYMD(utils.VENUS_DATE)) + "'");
          case utils.STRESA:
            return lq.replace(/\:filter/, "WHERE B >= date '" + (utils.toYMD(utils.STRESA_DATE)) + "'");
          default:
            return lq.replace(/\:filter/, '');
        }
      }).call(this);
      https.get(utils.qstring(lq), (function(_this) {
        return function(res) {
          var body;
          body = '';
          res.setEncoding('utf-8');
          res.on('data', function(d) {
            return body += d;
          });
          res.on('error', function(e) {
            return console.log("query error: " + e);
          });
          res.on('end', function() {
            var json, k, len, r, recs;
            json = utils.parseResponse(body);
            recs = utils.qresult(json);
            for (k = 0, len = recs.length; k < len; k++) {
              r = recs[k];
              lfreq[r.lwc1][0] += 1;
              lfreq[r.lwc2][1] += 1;
              lfreq[r.lwc3][2] += 1;
              lfreq[r.lwc4][3] += 1;
              lfreq[r.lwc5][4] += 1;
              lfreq[r.lwc6][5] += 1;
              lfreq[r.lwc7][6] += 1;
              lfreq[r.lwcp][7] += 1;
            }
            _this.lfreq = lfreq;
            return _this.drawLgraph();
          });
          return null;
        };
      })(this));
      jq = 'SELECT BE\n:filter';
      jq = (function() {
        switch (this.drum) {
          case utils.VENUS:
            return jq.replace(/\:filter/, "WHERE B <= date '" + (utils.toYMD(utils.VENUS_DATE)) + "'");
          case utils.STRESA:
            return jq.replace(/\:filter/, "WHERE B >= date '" + (utils.toYMD(utils.STRESA_DATE)) + "'");
          default:
            return jq.replace(/\:filter/, '');
        }
      }).call(this);
      https.get(utils.qstring(jq), (function(_this) {
        return function(res) {
          var body, jfreq, k;
          jfreq = [];
          for (i = k = 0; k <= 9; i = ++k) {
            jfreq.push([0, 0, 0, 0, 0, 0]);
          }
          body = '';
          res.setEncoding('utf-8');
          res.on('data', function(d) {
            return body += d;
          });
          res.on('error', function(e) {
            return console.log("query error: " + e);
          });
          res.on('end', function() {
            var a, arr, json, l, len, n, recs;
            json = utils.parseResponse(body);
            recs = utils.qresult(json);
            arr = recs.map(function(r) {
              return r.jwc.split('').map(function(e) {
                return parseInt(e);
              });
            });
            for (l = 0, len = arr.length; l < len; l++) {
              a = arr[l];
              for (i in a) {
                n = a[i];
                jfreq[n][i]++;
              }
            }
            return _this.jfreq = jfreq;
          });
          return null;
        };
      })(this));
      return null;
    },
    drumChanged: function() {
      console.log("Drum is:", this.drum);
      return this.getFreq();
    }
  },
  created: function() {
    this.getTotalDraws();
    this.getLastDraw();
    return this.getFreq();
  }
});
